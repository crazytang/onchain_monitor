import datetime
import json

import eth_abi
from django.core.files import File
from unittest import TestCase

from web3 import Web3

from oc_django.etherem.objects.contract_receipt import ContractReceipt
from oc_django.helpers.utils import get_param_data
from oc_django.libs.log_service import LogService
from onchain_monitor.services.contract_method_hash_service import ContractMethodHashService


class TestAbiCoder(TestCase):

    def setUp(self) -> None:
        pass

    def test_function_abi_decode(self):
        self.skipTest('ignore')
        method_sign = 'approve(address,uint256)'
        # method_sign = 'withdrawCollateral(uint256,address)'
        data = '0x095ea7b3000000000000000000000000f04422f8ea28453a3a6cf25260ec9d21e07d7aa80000000000000000000000000000001d6329f1c35ca4bfabb9f5610000000000'
        # data = '0000000000000000000000000000000000000000000000000429d069189e0000'

        param_data = get_param_data(method_sign, data)
        self.assertEqual(len(param_data), 2)
        self.assertTrue(Web3.isAddress(param_data[0]['value']))
        self.assertTrue(param_data[1]['value'] > 0)
        print('param_data', param_data)

        method_sign = 'setAddresses(address[])'
        data = '0xb957172100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000019000000000000000000000000aac046662e05c0c7967f68e6197aeec53f846934000000000000000000000000008f2ae31ccb2264df6d4329f0a0b5987cfac08f0000000000000000000000008fd64d486b1fad3db475f13b4d7855dcea6fe4bb000000000000000000000000c9ef0e2ff0424908885d7b4f9179fd674eff9b55000000000000000000000000ce40d570e8338438bff454521c48a48feb41c67b0000000000000000000000002bbe78b38e61c3840a5e3a51e0ad56248d8d8eb0000000000000000000000000701b1603fc550ffad5b2c307bd812dbf68426d0a000000000000000000000000da4f634cba43499b8d4d8f6c841ee0f0cf054bdd00000000000000000000000057db38028e1fd1dff6085d2489b2a6dabf0a8d8e0000000000000000000000006e667a6e2104924a9e78701ba48ef708b166128200000000000000000000000003040d09fd75f60a581adb0b4ec65165f68e4dc200000000000000000000000028d87dc87cea3be107e0e3677277425aa5868be40000000000000000000000009304a089f9ba8148c9089af6750b09b2eeb1f12a000000000000000000000000d131a4bca6d5e884f08ec4f7774245f85a0e40f80000000000000000000000004df85ca554c488e88ad830c1e43087ce7a4676ca000000000000000000000000a78656a5b1959edf04214dc20da7891712db499d00000000000000000000000037be72704658562d5f83269b2a33d9fbfd081dde000000000000000000000000a2b3bb0768dfbf9b0c4300df2a57edf22d8244b0000000000000000000000000f561f5a97a09edacb0f09765379c217b3496bb5000000000000000000000000036de1fc53aee78f78f9743446a45bcbd3e5f47e60000000000000000000000007c115b464c0054e161c1c3f8592b51af5f67dfb00000000000000000000000008cb3f1086e7488ca709062b94c33ba98bac5f3cc000000000000000000000000cbf7b4d3a93249379203478e701964c06f6875640000000000000000000000004c7c0f34deec9b37520c07fd2d362f0122e24f74000000000000000000000000795028a03f64d8c7fbcd0926171ce80239c6913f'

        param_data = get_param_data(method_sign, data)
        self.assertTrue(len(param_data[0]['value']) > 0)
        self.assertTrue(Web3.isAddress(param_data[0]['value'][0]))
        print('param_data', param_data)

    def test_event_abi_coder(self):
        tx_receipt = '{"to":"0xaAc046662e05C0c7967F68E6197aeEC53f846934","from":"0x9B7094506D15dd2977b688a22bbb6dF5501549e7","contractAddress":null,"transactionIndex":2,"gasUsed":{"type":"BigNumber","hex":"0x242c5a"},"logsBloom":"0x00800042000010000000000000000008400000000100010020000000000000000020000000000000000100000000000010020000000020000000800000200000044000000400000800000008000000000000000000000000200000000100000040002000820000000280100000004804000000200000088006000010001800000000000000000080002000000000000000000800000000000006400000000000020000000000000008000000800001000000040000200000000000040000200000400022000000000010000000200000840020000000000000000000100620000110002002000080100000000000008000000080000008000000100000000000","blockHash":"0x19c40bf150db68ddf1c84960299d083769605a2f53fda270feebc13e51163185","transactionHash":"0x9af8873c0b6d4d34dfd5df754c2a2c49748d083d4fdabba12490d80aea22c96e","logs":[{"transactionIndex":2,"blockNumber":31680355,"transactionHash":"0x9af8873c0b6d4d34dfd5df754c2a2c49748d083d4fdabba12490d80aea22c96e","address":"0x008f2aE31ccb2264df6d4329f0A0b5987CfAc08f","topics":["0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef","0x0000000000000000000000000000000000000000000000000000000000000000","0x0000000000000000000000004df85ca554c488e88ad830c1e43087ce7a4676ca"],"data":"0x00000000000000000000000000000000000000000000000000081a44ad41424b","logIndex":2,"blockHash":"0x19c40bf150db68ddf1c84960299d083769605a2f53fda270feebc13e51163185"},{"transactionIndex":2,"blockNumber":31680355,"transactionHash":"0x9af8873c0b6d4d34dfd5df754c2a2c49748d083d4fdabba12490d80aea22c96e","address":"0x03040d09Fd75f60A581AdB0B4ec65165f68e4dc2","topics":["0x0058b84c4abc8dec84b3009e98d0c9ad3697af85138ca07fedc53cc3d920b7cc"],"data":"0x0000000000000000000000004df85ca554c488e88ad830c1e43087ce7a4676ca000000000000000000000000008f2ae31ccb2264df6d4329f0a0b5987cfac08f00000000000000000000000000000000000000000000000000081a44ad41424b","logIndex":3,"blockHash":"0x19c40bf150db68ddf1c84960299d083769605a2f53fda270feebc13e51163185"},{"transactionIndex":2,"blockNumber":31680355,"transactionHash":"0x9af8873c0b6d4d34dfd5df754c2a2c49748d083d4fdabba12490d80aea22c96e","address":"0x008f2aE31ccb2264df6d4329f0A0b5987CfAc08f","topics":["0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef","0x0000000000000000000000000000000000000000000000000000000000000000","0x0000000000000000000000008fd64d486b1fad3db475f13b4d7855dcea6fe4bb"],"data":"0x00000000000000000000000000000000000000000000000000081a44ad41424b","logIndex":4,"blockHash":"0x19c40bf150db68ddf1c84960299d083769605a2f53fda270feebc13e51163185"},{"transactionIndex":2,"blockNumber":31680355,"transactionHash":"0x9af8873c0b6d4d34dfd5df754c2a2c49748d083d4fdabba12490d80aea22c96e","address":"0xdA4f634CBa43499B8d4d8F6C841EE0F0cf054BDD","topics":["0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef","0x0000000000000000000000008d8fa02d1f4476363c5f6a0fcba95bd7656b0045","0x00000000000000000000000003040d09fd75f60a581adb0b4ec65165f68e4dc2"],"data":"0x0000000000000000000000000000000000000000000000000325cf9d1cfb010e","logIndex":5,"blockHash":"0x19c40bf150db68ddf1c84960299d083769605a2f53fda270feebc13e51163185"},{"transactionIndex":2,"blockNumber":31680355,"transactionHash":"0x9af8873c0b6d4d34dfd5df754c2a2c49748d083d4fdabba12490d80aea22c96e","address":"0x008f2aE31ccb2264df6d4329f0A0b5987CfAc08f","topics":["0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef","0x0000000000000000000000008fd64d486b1fad3db475f13b4d7855dcea6fe4bb","0x0000000000000000000000008d8fa02d1f4476363c5f6a0fcba95bd7656b0045"],"data":"0x00000000000000000000000000000000000000000000000000081a44ad41424b","logIndex":6,"blockHash":"0x19c40bf150db68ddf1c84960299d083769605a2f53fda270feebc13e51163185"},{"transactionIndex":2,"blockNumber":31680355,"transactionHash":"0x9af8873c0b6d4d34dfd5df754c2a2c49748d083d4fdabba12490d80aea22c96e","address":"0x008f2aE31ccb2264df6d4329f0A0b5987CfAc08f","topics":["0x8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925","0x0000000000000000000000008fd64d486b1fad3db475f13b4d7855dcea6fe4bb","0x000000000000000000000000e592427a0aece92de3edee1f18e0157c05861564"],"data":"0xfffffffffffffffffffffffffffffffffffffffffffffffef62ddb2af73bf9b2","logIndex":7,"blockHash":"0x19c40bf150db68ddf1c84960299d083769605a2f53fda270feebc13e51163185"},{"transactionIndex":2,"blockNumber":31680355,"transactionHash":"0x9af8873c0b6d4d34dfd5df754c2a2c49748d083d4fdabba12490d80aea22c96e","address":"0x8d8FA02d1f4476363C5f6a0Fcba95bd7656B0045","topics":["0xc42079f94a6350d7e6235f29174924f928cc2ac818eb64fed8004e115fbcca67","0x000000000000000000000000e592427a0aece92de3edee1f18e0157c05861564","0x00000000000000000000000003040d09fd75f60a581adb0b4ec65165f68e4dc2"],"data":"0x00000000000000000000000000000000000000000000000000081a44ad41424bfffffffffffffffffffffffffffffffffffffffffffffffffcda3062e304fef20000000000000000000000000000000000000009f99944c9479de0dd7bcab37100000000000000000000000000000000000000000000221011e96edeaa0f03fb000000000000000000000000000000000000000000000000000000000000b3b3","logIndex":8,"blockHash":"0x19c40bf150db68ddf1c84960299d083769605a2f53fda270feebc13e51163185"},{"transactionIndex":2,"blockNumber":31680355,"transactionHash":"0x9af8873c0b6d4d34dfd5df754c2a2c49748d083d4fdabba12490d80aea22c96e","address":"0x8Fd64d486B1fAd3dB475f13B4d7855dcea6FE4Bb","topics":["0x6782190c91d4a7e8ad2a867deed6ec0a970cab8ff137ae2bd4abd92b3810f4d3"],"data":"0x000000000000000000000000008f2ae31ccb2264df6d4329f0a0b5987cfac08f000000000000000000000000da4f634cba43499b8d4d8f6c841ee0f0cf054bdd00000000000000000000000003040d09fd75f60a581adb0b4ec65165f68e4dc200000000000000000000000000000000000000000000000000081a44ad41424b0000000000000000000000000000000000000000000000000325cf9d1cfb010e","logIndex":9,"blockHash":"0x19c40bf150db68ddf1c84960299d083769605a2f53fda270feebc13e51163185"},{"transactionIndex":2,"blockNumber":31680355,"transactionHash":"0x9af8873c0b6d4d34dfd5df754c2a2c49748d083d4fdabba12490d80aea22c96e","address":"0xdA4f634CBa43499B8d4d8F6C841EE0F0cf054BDD","topics":["0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef","0x00000000000000000000000003040d09fd75f60a581adb0b4ec65165f68e4dc2","0x0000000000000000000000000000000000000000000000000000000000000000"],"data":"0x0000000000000000000000000000000000000000000000000325cf9d1cfb010e","logIndex":10,"blockHash":"0x19c40bf150db68ddf1c84960299d083769605a2f53fda270feebc13e51163185"},{"transactionIndex":2,"blockNumber":31680355,"transactionHash":"0x9af8873c0b6d4d34dfd5df754c2a2c49748d083d4fdabba12490d80aea22c96e","address":"0x03040d09Fd75f60A581AdB0B4ec65165f68e4dc2","topics":["0x09267ef82ba30ba065c4f5a9ce8047e731d686f96c78807a3a9186797194069e"],"data":"0x000000000000000000000000da4f634cba43499b8d4d8f6c841ee0f0cf054bdd00000000000000000000000000000000000000000000000000081a44ad41424b","logIndex":11,"blockHash":"0x19c40bf150db68ddf1c84960299d083769605a2f53fda270feebc13e51163185"},{"transactionIndex":2,"blockNumber":31680355,"transactionHash":"0x9af8873c0b6d4d34dfd5df754c2a2c49748d083d4fdabba12490d80aea22c96e","address":"0xdA4f634CBa43499B8d4d8F6C841EE0F0cf054BDD","topics":["0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef","0x0000000000000000000000000000000000000000000000000000000000000000","0x00000000000000000000000057db38028e1fd1dff6085d2489b2a6dabf0a8d8e"],"data":"0x00000000000000000000000000000000000000000000000027feb933f9858664","logIndex":12,"blockHash":"0x19c40bf150db68ddf1c84960299d083769605a2f53fda270feebc13e51163185"},{"transactionIndex":2,"blockNumber":31680355,"transactionHash":"0x9af8873c0b6d4d34dfd5df754c2a2c49748d083d4fdabba12490d80aea22c96e","address":"0x2FF360C86d28E804D51556D6738366876550e7b6","topics":["0xe6284d1c5cda1861f9f340e4f044cf3b6f6456b11db8177a9e666a916f227947","0x00000000000000000000000057db38028e1fd1dff6085d2489b2a6dabf0a8d8e"],"data":"0x2313f8d0b76a0be3687c0a7a27a2c8d41511dcf9e4da65e3cd15fea5b884e7da000000000000000000000000000000000000000000000fe1c215e8f838e000000000000000000000000000000000000000000000000000ef398567b2e3875b7000000000000000000000000000000000000000000000000000000000627dd5f8000000000000000000000000000000000000000000000000000000000083d600","logIndex":13,"blockHash":"0x19c40bf150db68ddf1c84960299d083769605a2f53fda270feebc13e51163185"},{"transactionIndex":2,"blockNumber":31680355,"transactionHash":"0x9af8873c0b6d4d34dfd5df754c2a2c49748d083d4fdabba12490d80aea22c96e","address":"0x8dBbEc332936c5Bb6c2E4be44db5b99ac2948A71","topics":["0xbee19f7c55f748d10386d1c0dcc008c99cb6858206e91f3392eac84d861ac99d","0x00000000000000000000000057db38028e1fd1dff6085d2489b2a6dabf0a8d8e"],"data":"0x00000000000000000000000000000000000000000000000027feb933f9858664000000000000000000000000000000000000000000000000001ed6eb565788e300000000000000000000000000000000000000000000000000000000628597c8","logIndex":14,"blockHash":"0x19c40bf150db68ddf1c84960299d083769605a2f53fda270feebc13e51163185"},{"transactionIndex":2,"blockNumber":31680355,"transactionHash":"0x9af8873c0b6d4d34dfd5df754c2a2c49748d083d4fdabba12490d80aea22c96e","address":"0x8dBbEc332936c5Bb6c2E4be44db5b99ac2948A71","topics":["0xfdf5aa6ade69a7ac33b076d924ab9d00b587abf11aaf1d0931cb476ac7565229","0x00000000000000000000000057db38028e1fd1dff6085d2489b2a6dabf0a8d8e"],"data":"0x00000000000000000000000000000000000000000000000027feb933f9858664","logIndex":15,"blockHash":"0x19c40bf150db68ddf1c84960299d083769605a2f53fda270feebc13e51163185"},{"transactionIndex":2,"blockNumber":31680355,"transactionHash":"0x9af8873c0b6d4d34dfd5df754c2a2c49748d083d4fdabba12490d80aea22c96e","address":"0x03040d09Fd75f60A581AdB0B4ec65165f68e4dc2","topics":["0x58e878cf51c57e353820255ee1acb7ee2ec31a0f34fecf6678dfad94cb107a0f"],"data":"0x000000000000000000000000aac046662e05c0c7967f68e6197aeec53f8469340000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000001034895a828496","logIndex":16,"blockHash":"0x19c40bf150db68ddf1c84960299d083769605a2f53fda270feebc13e51163185"},{"transactionIndex":2,"blockNumber":31680355,"transactionHash":"0x9af8873c0b6d4d34dfd5df754c2a2c49748d083d4fdabba12490d80aea22c96e","address":"0x008f2aE31ccb2264df6d4329f0A0b5987CfAc08f","topics":["0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef","0x0000000000000000000000009b7094506d15dd2977b688a22bbb6df5501549e7","0x0000000000000000000000000000000000000000000000000000000000000000"],"data":"0x00000000000000000000000000000000000000000000003635c9adc5dea00000","logIndex":17,"blockHash":"0x19c40bf150db68ddf1c84960299d083769605a2f53fda270feebc13e51163185"},{"transactionIndex":2,"blockNumber":31680355,"transactionHash":"0x9af8873c0b6d4d34dfd5df754c2a2c49748d083d4fdabba12490d80aea22c96e","address":"0xaAc046662e05C0c7967F68E6197aeEC53f846934","topics":["0x01e4773e86e2ca87566e62a63d09aa6883dd091b5d9221bb54a6614ef7db18d3","0x0000000000000000000000009b7094506d15dd2977b688a22bbb6df5501549e7"],"data":"0x000000000000000000000000f561f5a97a09edacb0f09765379c217b3496bb5000000000000000000000000000000000000000000000003635c9adc5dea00000","logIndex":18,"blockHash":"0x19c40bf150db68ddf1c84960299d083769605a2f53fda270feebc13e51163185"}],"blockNumber":31680355,"confirmations":1,"cumulativeGasUsed":{"type":"BigNumber","hex":"0x2619c2"},"effectiveGasPrice":{"type":"BigNumber","hex":"0x6147ba4d"},"status":1,"type":0,"byzantium":true}'
        tx_receipt = json.loads(tx_receipt)

        logs = tx_receipt['logs']
        method_hash = ''
        for log in logs:
            topics = log['topics']
            method_hash = topics[0]
            data = ''
            for i in range(1, len(topics)):
                data += topics[i][2:]

            data += log['data'][2:]
            print('method_hash', method_hash)
            print('data', data)

            method_hash_info = ContractMethodHashService.get_one_from_hash(method_hash)
            if not method_hash_info:
                continue

            method_sign = method_hash_info.method_sign
            print('method_sign', method_sign)
            param_data = get_param_data(method_sign, data)
            print('param_data', param_data)
            # self.assertTrue(Web3.isAddress(param_data[0]['value']))
            # self.assertTrue(Web3.isAddress(param_data[1]['value']))
            # self.assertTrue(param_data[2]['value'] > 0)
            # return

